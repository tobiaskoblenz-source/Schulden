<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Schulden Manager ‚Äì Dual View</title>
<link rel="manifest" href="./manifest.webmanifest">

<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable"></script>


<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --panel:#111827;
  --text:#f1f5f9;
  --muted:#94a3b8;
  --accent:#e6b8a2;
  --danger:#ef4444;
  --success:#22c55e;
}

body{
  margin:0;
  font-family:Inter, system-ui, Arial, sans-serif;
  background:linear-gradient(180deg,#1e293b,#0f172a);
  color:var(--text);
}

.container{max-width:1300px;margin:auto;padding:20px;}

.card{
  background:var(--card);
  border-radius:22px;
  padding:20px;
  margin-bottom:20px;
  border:1px solid rgba(255,255,255,.06);
  box-shadow:0 10px 30px rgba(0,0,0,.45);
}

input,button,select{
  padding:12px 16px;
  margin:8px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.08);
  font-size:16px;
  text-align:center;
  background:var(--panel);
  color:var(--text);
}

button{
  background:var(--accent);
  color:#1e293b;
  font-weight:600;
  cursor:pointer;
  transition:.15s ease;
}

button:hover{
  transform:translateY(-2px);
}

button.secondary{
  background:var(--panel);
  color:var(--text);
}

.stats{display:flex;gap:10px;flex-wrap:wrap;}
.stat{
  flex:1;
  background:var(--panel);
  padding:15px;
  border-radius:16px;
  text-align:center;
  font-weight:bold;
}
.stat span{
  display:block;
  font-size:24px;
  margin-top:6px;
  color:var(--accent);
}

table{width:100%;border-collapse:collapse;}
th,td{
  border:1px solid rgba(255,255,255,.08);
  padding:8px;
}
th{background:var(--panel);}

.badgeOpen{background:var(--danger);color:white;}
.badgePaid{background:var(--success);color:white;}

.mobileCard{
  background:var(--panel);
  border-radius:18px;
  padding:14px;
  margin:10px 0;
}

#fabAdd{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  width:65px;
  height:65px;
  border-radius:50%;
  font-size:30px;
  background:var(--accent);
  color:#1e293b;
  box-shadow:0 10px 30px rgba(0,0,0,.5);
}

@media (max-width:768px){
  table{display:none;}
}

h2{text-align:center;margin-top:0;}
.viewSwitch{display:flex;justify-content:center;gap:15px;flex-wrap:wrap;}
.formRow{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:15px;}
.actionRow{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:10px;}
.stats{justify-content:center;}
table{margin:auto;}
.card{text-align:center;}


@media (min-width: 769px){
  #fabAdd{display:none !important;}
}


@media (min-width: 769px){
  #fabAdd{display:none !important;}
  #addModal{display:none !important;}
}


/* =========================
   MOBILE BOTTOM NAV (Premium Glow - B)
   ========================= */
.mobileBottomNav{
  display:none;
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  width:min(520px, calc(100% - 28px));
  height:68px;
  padding:10px 14px;
  border-radius:26px;
  background:#111827;
  border:1px solid rgba(255,255,255,.08);
  box-shadow:0 18px 45px rgba(0,0,0,.55);
  z-index:10001;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}

.mobileBottomNav .navBtn{
  width:46px;
  height:46px;
  border-radius:18px;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.06);
  color:var(--text);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0;
  margin:0;
  box-shadow:none;
  transform:none;
  font-size:20px;
}

.mobileBottomNav .navBtn:active{
  filter:brightness(.95);
}

.mobileBottomNav .navPlus{
  width:58px;
  height:58px;
  border-radius:22px;
  background:var(--accent);
  color:#1e293b;
  border:1px solid rgba(255,255,255,.10);
  box-shadow:0 0 22px rgba(230,184,162,.35), 0 20px 45px rgba(0,0,0,.55);
  font-size:26px;
  font-weight:800;
}

.mobileBottomNav .navPlus:hover{transform:none;}

@media (max-width:768px){
  .container{padding-bottom:120px;} /* Platz f√ºr Bottom Nav */
  .mobileBottomNav{display:flex;}
  /* Eingabemaske (Inline-Form) komplett entfernen auf Mobile */
  #inlineForm{display:none !important;}
  /* FAB ausblenden (Plus sitzt in Bottom Nav) */
  #fabAdd{display:none !important;}
}


/* Hide bottom nav when modal is open (so it doesn't block modal buttons) */
body.modalOpen .mobileBottomNav{display:none !important;}

</style>

</head>

<body>
<script>
  // Prevent UI flash before auth check
  document.documentElement.style.visibility = "hidden";
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCWAvq7GuEhF2jaL8xFrb_MJ34_dZD0Hkk",
    authDomain: "schulden-36186.firebaseapp.com",
    projectId: "schulden-36186",
    storageBucket: "schulden-36186.firebasestorage.app",
    messagingSenderId: "483402986505",
    appId: "1:483402986505:web:1bf7cafce628bbd486b4d8"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Make logout callable from UI
  window.logout = async () => {
    await signOut(auth);
    location.replace("./login.html");
  };

  async function loadFromCloud(uid){
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (snap.exists() && window.__setDebtsFromCloud) {
      window.__setDebtsFromCloud(snap.data().debts || []);
    }
  }

  window.__saveDebtsToCloud = async (debts) => {
    const user = auth.currentUser;
    if (!user) return;
    const ref = doc(db, "users", user.uid);
    await setDoc(ref, { debts, updatedAt: Date.now() }, { merge: true });
  };

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.replace("./login.html");
      return;
    }
    // show UI
    document.documentElement.style.visibility = "visible";
    // load cloud -> local
    await loadFromCloud(user.uid);
  });
</script>
<div class="container">

<div class="card">
  <h2 style="text-align:center;margin-top:0;">Schulden Manager</h2>

  <div class="viewSwitch">
    <button id="btnDesktop" class="secondary" type="button">üñ• Desktop</button>
    <button id="btnMobile" class="secondary" type="button">üì± Handy</button>
  </div>

  <!-- Inline Formular (Desktop/Tablet) -->
  <div id="inlineForm">
    <div class="formRow">
      <input id="name" placeholder="Name">
      <input id="grund" placeholder="Grund">
      <input id="betrag" type="number" placeholder="Betrag ‚Ç¨">
      <input id="datum" type="date">
      <select id="status">
        <option>offen</option>
        <option>bezahlt</option>
      </select>
    </div>

    <div class="actionRow">
      <button id="btnAdd" type="button">Hinzuf√ºgen</button>
      <button id="btnDark" type="button">üåô Dark</button>
      <button id="btnBackup" type="button">üíæ Backup</button>
      <button id="btnBackupPick" type="button">üìÅ Backup (Ort w√§hlen)</button>
      <button id="btnRestore" type="button">üìÇ Restore</button>
      <button id="btnLogoutTop" class="secondary" type="button">üö™ Logout</button>
    </div>
  </div>

  <!-- Auf Mobile zeigen wir nur Dark/Backup/Restore als Reihe optional √ºber Bottom? Hier lassen wir sie weg f√ºr clean ‚Äì per FAB -->
  <input id="restoreFile" type="file" accept=".godmode,application/octet-stream,application/json,text/plain" style="display:none">

  <div id="backupStatus">Letztes Backup: ‚Äì</div>
  <div class="smallMuted">Tipp: Backup-Datei in Google Drive speichern, auf anderem Ger√§t herunterladen, dann Restore.</div>
</div>

<div class="card stats" id="statsCard">
  <div class="stat">Gesamt Schulden: <span id="sum">0</span> ‚Ç¨</div>
  <div class="stat">Offen: <span id="open">0</span> ‚Ç¨</div>
  <div class="stat">Bezahlt: <span id="paid">0</span> ‚Ç¨</div>
</div>

<div class="card">
  <input id="search" placeholder="üîé Suche...">

  <!-- DESKTOP VIEW -->
  <div id="desktopTable">
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Grund</th><th>Betrag</th>
          <th>Datum</th><th>Status</th><th>Aktion</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- MOBILE VIEW -->
  <div id="mobileList"></div>

  <br>
  <div class="actionRow">
    <button id="btnExcel" type="button">Excel Export</button>
    <button id="btnPDF" type="button">PDF Export</button>
    <button id="btnClear" class="btn-delete" type="button">Alles l√∂schen</button>
  </div>
</div>

</div>

<!-- Add Modal (f√ºr Handy) -->
<div id="addModal" class="modalOverlay" aria-hidden="true">
  <div class="modalBox">
    <button class="modalCloseX" type="button" id="addCloseX">‚úï</button>
    <h3 style="margin-top:0;text-align:center;">‚ûï Neue Schuld</h3>

    <div class="formRow" style="margin-top:0;">
      <input id="m_name" placeholder="Name">
      <input id="m_grund" placeholder="Grund">
      <input id="m_betrag" type="number" placeholder="Betrag ‚Ç¨">
      <input id="m_datum" type="date">
      <select id="m_status">
        <option>offen</option>
        <option>bezahlt</option>
      </select>
    </div>

    <div class="modalActions">
      <button id="m_add" type="button">Hinzuf√ºgen</button>
      <button id="m_dark" type="button">üåô Dark</button>
      <button id="m_backup" type="button">üíæ Backup</button>
      <button id="m_backup_pick" type="button">üìÅ Ort w√§hlen</button>
      <button id="m_restore" type="button">üìÇ Restore</button>
      <button id="m_logout" class="secondary" type="button">üö™ Logout</button>
    </div>
  </div>
</div>

<button id="fabAdd" type="button" aria-label="Neu">Ôºã</button>

<script>
/* ---------- State ---------- */
let debts = [];

// Called by Firebase (cloud -> local)
window.__setDebtsFromCloud = function(cloudDebts){
  debts = Array.isArray(cloudDebts) ? cloudDebts : [];
  save();
  render();
};
try {
  const raw = localStorage.getItem("godmode_debts");
  debts = raw ? JSON.parse(raw) : [];
  if(!Array.isArray(debts)) debts = [];
} catch (e) {
  console.warn("Konnte godmode_debts nicht laden, setze neu.", e);
  debts = [];
}

let currentView = (localStorage.getItem("godmode_view") || "desktop");
if(currentView !== "desktop" && currentView !== "mobile") currentView = "desktop";

/* Theme restore */
if(localStorage.getItem("godmode_dark") === "1"){
  document.body.classList.add("dark");
}

function save(){
  localStorage.setItem("godmode_debts", JSON.stringify(debts));
  if (window.__saveDebtsToCloud) {
    window.__saveDebtsToCloud(debts).catch(console.error);
  }
}

/* ---------- View switch ---------- */
function setView(v){
  currentView = v;
  localStorage.setItem("godmode_view", v);
  document.getElementById("desktopTable").style.display = (v==="desktop") ? "block" : "none";
  document.getElementById("mobileList").style.display   = (v==="mobile")  ? "block" : "none";
  document.getElementById("btnDesktop").classList.toggle("activeView", v==="desktop");
  document.getElementById("btnMobile").classList.toggle("activeView", v==="mobile");
  render();
}

/* ---------- Backup status ---------- */
function setBackupStatusNow(){
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  const txt = "Letztes Backup: " + hh + ":" + mm + ":" + ss;
  document.getElementById("backupStatus").innerText = txt;
  localStorage.setItem("godmode_last_backup", txt);
}
(function initBackupStatus(){
  const last = localStorage.getItem("godmode_last_backup");
  if(last) document.getElementById("backupStatus").innerText = last;
})();

/* ---------- Backup / Restore ---------- */
function makeDatedFilename(){
  const t = new Date();
  const yyyy = t.getFullYear();
  const mo = String(t.getMonth()+1).padStart(2,'0');
  const dd = String(t.getDate()).padStart(2,'0');
  const hh = String(t.getHours()).padStart(2,'0');
  const mi = String(t.getMinutes()).padStart(2,'0');
  return "schulden_backup_" + yyyy + "-" + mo + "-" + dd + "_" + hh + "-" + mi + ".godmode";
}

function downloadBackup(){
  const payload = { version: 1, exportedAt: new Date().toISOString(), debts };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/octet-stream"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = makeDatedFilename();
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
  setBackupStatusNow();
}

async function downloadBackupWithPicker(){
  if(!window.showSaveFilePicker){
    // Fallback
    downloadBackup();
    return;
  }
  const payload = { version: 1, exportedAt: new Date().toISOString(), debts };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/octet-stream"});

  const handle = await window.showSaveFilePicker({
    suggestedName: makeDatedFilename(),
    types: [{ description: "Schulden Backup", accept: { "application/octet-stream": [".godmode"] } }]
  });
  const writable = await handle.createWritable();
  await writable.write(blob);
  await writable.close();
  setBackupStatusNow();
}

function triggerRestore(){
  document.getElementById("restoreFile").click();
}

function restoreBackup(event){
  const file = event.target.files && event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try{
      const data = JSON.parse(String(reader.result||""));
      const imported = Array.isArray(data) ? data : data.debts;
      if(!Array.isArray(imported)) throw new Error("Ung√ºltiges Format");

      // normalize minimal
      debts = imported.map(d => ({
        name: String(d.name ?? "").trim(),
        grund: String(d.grund ?? "").trim(),
        betrag: Number(d.betrag ?? 0),
        datum: String(d.datum ?? ""),
        status: (d.status === "bezahlt") ? "bezahlt" : "offen",
        history: Array.isArray(d.history) ? d.history.map(h => ({
          date: String(h.date ?? ""),
          amount: Number(h.amount ?? 0)
        })) : []
      }));

      save();
      render();
      alert("Restore erfolgreich ‚úÖ");
    } catch(e){
      console.error(e);
      alert("Restore fehlgeschlagen ‚ùå (falsche Datei)");
    } finally {
      event.target.value="";
    }
  };
  reader.readAsText(file);
}

/* ---------- Helpers ---------- */
function sumHistory(d){
  if(!d.history || !Array.isArray(d.history)) return 0;
  return d.history.reduce((acc,h)=>acc + (Number(h.amount)||0), 0);
}
function lastPaymentDate(d){
  if(!d.history || d.history.length===0) return "‚Äì";
  let latest = d.history[0].date;
  for(const h of d.history){
    if(h.date && new Date(h.date) > new Date(latest)) latest = h.date;
  }
  return latest || "‚Äì";
}

/* ---------- Core ---------- */
function addDebtFromInputs(prefix){
  const name = document.getElementById(prefix + "name").value.trim();
  const grund = document.getElementById(prefix + "grund").value.trim();
  const betrag = parseFloat(document.getElementById(prefix + "betrag").value);
  const datum = document.getElementById(prefix + "datum").value;
  const status = document.getElementById(prefix + "status").value;

  if(!name || !grund || isNaN(betrag) || !datum){
    alert("Bitte alle Felder korrekt ausf√ºllen!");
    return false;
  }

  debts.push({name,grund,betrag,datum,status,history:[]});
  save();
  render();
  return true;
}

function removeDebt(i){debts.splice(i,1);save();render();}
function toggleStatus(i){debts[i].status=debts[i].status==="offen"?"bezahlt":"offen";save();render();}

function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("godmode_dark", document.body.classList.contains("dark") ? "1" : "0");
}

function paySingleDebt(i){
  let d=debts[i];
  if(d.status==="bezahlt"){alert("Diese Schuld ist bereits bezahlt!");return;}
  let payAmount=parseFloat(prompt("Wie viel willst du von dieser Schuld bezahlen?", d.betrag));
  if(isNaN(payAmount)||payAmount<=0){alert("Ung√ºltiger Betrag!");return;}

  const todayStr=new Date().toISOString().slice(0,10);

  if(!d.history) d.history=[];
  d.history.push({date:todayStr, amount: Math.min(payAmount, Number(d.betrag)||0)});

  if(payAmount>=d.betrag){d.betrag=0; d.status="bezahlt";}
  else{d.betrag = (Number(d.betrag)||0) - payAmount;}

  d.datum=todayStr;
  save();
  render();
}

/* ---------- Modals (History + Info as alerts for simplicity) ---------- */
function showHistory(i){
  const d=debts[i];
  if(!d.history || d.history.length===0){ alert("Keine Abbauten bisher"); return; }
  const sorted=[...d.history].sort((a,b)=>new Date(b.date)-new Date(a.date));
  const lines=sorted.map(h => h.date + "  -  " + (Number(h.amount)||0).toFixed(2) + "‚Ç¨");
  alert(lines.join("\n"));
}
function showInfo(i){
  const d=debts[i];
  const paidSum = sumHistory(d);
  const remaining = Number(d.betrag)||0;
  const original = paidSum + remaining;
  const count = (d.history && Array.isArray(d.history)) ? d.history.length : 0;
  const lastDate = lastPaymentDate(d);

  const msg =
    "Name: " + d.name + "\n" +
    "Grund: " + d.grund + "\n" +
    "Urspr√ºnglich: " + original.toFixed(2) + " ‚Ç¨\n" +
    "Bereits abgebaut: " + paidSum.toFixed(2) + " ‚Ç¨\n" +
    "Restschuld: " + remaining.toFixed(2) + " ‚Ç¨\n" +
    "Status: " + (d.status || "‚Äì") + "\n" +
    "Anzahl Zahlungen: " + count + "\n" +
    "Letzte Zahlung: " + lastDate;
  alert(msg);
}

/* ---------- Render ---------- */
function render(){
  const s=(document.getElementById("search").value||"").toLowerCase();

  let sum=0,open=0,paid=0;
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";
  const mobile=document.getElementById("mobileList");
  mobile.innerHTML="";

  debts.forEach((d,i)=>{
    if(s && !JSON.stringify(d).toLowerCase().includes(s)) return;

    sum+=Number(d.betrag)||0;
    if(d.status==="offen") open+=Number(d.betrag)||0; else paid+=Number(d.betrag)||0;

    const row = document.createElement("tr");
    row.innerHTML =
      "<td>"+escapeHtml(d.name)+"</td>" +
      "<td>"+escapeHtml(d.grund)+"</td>" +
      "<td>"+(Number(d.betrag)||0).toFixed(2)+"‚Ç¨</td>" +
      "<td>"+(d.datum||"")+"</td>" +
      "<td>"+(d.status||"")+"</td>" +
      "<td>" +
        "<button class='btn-status' type='button'>Status</button> " +
        "<button class='btn-delete' type='button'>L√∂schen</button> " +
        "<button class='btn-pay' type='button'>Abbauen</button> " +
        "<button class='btn-history' type='button'>Historie</button> " +
        "<button class='btn-info' type='button'>Info</button>" +
      "</td>";
    const btns = row.querySelectorAll("button");
    btns[0].addEventListener("click", ()=>toggleStatus(i));
    btns[1].addEventListener("click", ()=>removeDebt(i));
    btns[2].addEventListener("click", ()=>paySingleDebt(i));
    btns[3].addEventListener("click", ()=>showHistory(i));
    btns[4].addEventListener("click", ()=>showInfo(i));
    tbody.appendChild(row);

    const badgeClass = (d.status==="offen") ? "badgeOpen" : "badgePaid";
    const badgeText  = (d.status==="offen") ? "OFFEN" : "BEZAHLT";
    const card = document.createElement("div");
    card.className="mobileCard";
    card.innerHTML =
      "<div class='mobileTop'>" +
        "<div>" +
          "<div style='font-weight:bold;font-size:16px;'>"+escapeHtml(d.name)+"</div>" +
          "<div style='color:#666;margin-top:2px;'>"+escapeHtml(d.grund)+"</div>" +
        "</div>" +
        "<div class='badge "+badgeClass+"'>"+badgeText+"</div>" +
      "</div>" +
      "<div style='margin-top:10px;'>" +
        "<div><b>Betrag:</b> "+(Number(d.betrag)||0).toFixed(2)+"‚Ç¨</div>" +
        "<div><b>Datum:</b> "+(d.datum||"")+"</div>" +
      "</div>" +
      "<div class='mobileRow'>" +
        "<button class='btn-status' type='button'>Status</button>" +
        "<button class='btn-delete' type='button'>L√∂schen</button>" +
        "<button class='btn-pay' type='button'>Abbauen</button>" +
        "<button class='btn-history' type='button'>Historie</button>" +
        "<button class='btn-info' type='button'>Info</button>" +
      "</div>";
    const cbtns = card.querySelectorAll("button");
    cbtns[0].addEventListener("click", ()=>toggleStatus(i));
    cbtns[1].addEventListener("click", ()=>removeDebt(i));
    cbtns[2].addEventListener("click", ()=>paySingleDebt(i));
    cbtns[3].addEventListener("click", ()=>showHistory(i));
    cbtns[4].addEventListener("click", ()=>showInfo(i));
    mobile.appendChild(card);
  });

  document.getElementById("sum").innerText=sum.toFixed(2);
  document.getElementById("open").innerText=open.toFixed(2);
  document.getElementById("paid").innerText=paid.toFixed(2);
}

function escapeHtml(str){
  return String(str||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ---------- Export ---------- */
function exportExcel(){
  const ws=XLSX.utils.json_to_sheet(debts);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Schulden");
  XLSX.writeFile(wb,"godmode_schulden.xlsx");
}
function exportPDF(){
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  doc.text("Schulden Manager Report",14,15);
  const rows=debts.map(d=>[d.name,d.grund,(Number(d.betrag)||0).toFixed(2)+"‚Ç¨",d.datum,d.status]);
  doc.autoTable({head:[["Name","Grund","Betrag","Datum","Status"]],body:rows,startY:20});
  doc.save("schulden_report.pdf");
}
function clearAll(){
  if(confirm("Alles l√∂schen?")){
    debts=[];
    save();
    render();
  }
}

/* ---------- Add Modal ---------- */
function openAddModal(){
  const modal = document.getElementById("addModal");
  modal.style.display = "block";
  modal.setAttribute("aria-hidden","false");
    document.body.classList.add("modalOpen");
// defaults
  document.getElementById("m_status").value = "offen";
  setTimeout(()=>document.getElementById("m_name").focus(), 50);
}
function closeAddModal(){
  const modal = document.getElementById("addModal");
  modal.style.display = "none";
  modal.setAttribute("aria-hidden","true");
  document.body.classList.remove("modalOpen");
}
function clearModalInputs(){
  document.getElementById("m_name").value="";
  document.getElementById("m_grund").value="";
  document.getElementById("m_betrag").value="";
  document.getElementById("m_datum").value="";
  document.getElementById("m_status").value="offen";
}

/* ---------- Wire up events safely ---------- */
document.getElementById("btnDesktop").addEventListener("click", ()=>setView("desktop"));
document.getElementById("btnMobile").addEventListener("click", ()=>setView("mobile"));

document.getElementById("btnAdd").addEventListener("click", ()=>{
  if(addDebtFromInputs("")){
    // clear inline fields
    document.getElementById("name").value="";
    document.getElementById("grund").value="";
    document.getElementById("betrag").value="";
    document.getElementById("datum").value="";
    document.getElementById("status").value="offen";
  }
});
document.getElementById("btnDark").addEventListener("click", toggleDark);
document.getElementById("btnBackup").addEventListener("click", downloadBackup);
document.getElementById("btnBackupPick").addEventListener("click", ()=>downloadBackupWithPicker().catch(err=>{console.error(err); alert("Konnte Speicher-Dialog nicht √∂ffnen.");}));
document.getElementById("btnRestore").addEventListener("click", triggerRestore);

document.getElementById("restoreFile").addEventListener("change", restoreBackup);

document.getElementById("btnExcel").addEventListener("click", exportExcel);
document.getElementById("btnPDF").addEventListener("click", exportPDF);
document.getElementById("btnClear").addEventListener("click", clearAll);

document.getElementById("fabAdd").addEventListener("click", openAddModal);
document.getElementById("addCloseX").addEventListener("click", closeAddModal);
document.getElementById("addModal").addEventListener("click", (e)=>{ if(e.target.id==="addModal") closeAddModal(); });

document.getElementById("m_add").addEventListener("click", ()=>{
  // map modal ids to expected prefixes via temporary copy
  document.getElementById("name").value = document.getElementById("m_name").value;
  document.getElementById("grund").value = document.getElementById("m_grund").value;
  document.getElementById("betrag").value = document.getElementById("m_betrag").value;
  document.getElementById("datum").value = document.getElementById("m_datum").value;
  document.getElementById("status").value = document.getElementById("m_status").value;

  if(addDebtFromInputs("")){
    clearModalInputs();
    closeAddModal();
  }
});
if(document.getElementById("m_dark")) document.getElementById("m_dark").addEventListener("click", toggleDark);
if(document.getElementById("m_backup")) document.getElementById("m_backup").addEventListener("click", downloadBackup);
if(document.getElementById("m_backup_pick")) document.getElementById("m_backup_pick").addEventListener("click", ()=>downloadBackupWithPicker().catch(err=>{console.error(err); alert("Konnte Speicher-Dialog nicht √∂ffnen.");}));
if(document.getElementById("m_restore")) document.getElementById("m_restore").addEventListener("click", triggerRestore);

document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeAddModal(); });
document.getElementById("search").addEventListener("input", render);

/* Init */
setView(currentView);
/* Force mobile view on small screens */
if(window.matchMedia && window.matchMedia("(max-width: 768px)").matches){
  setView("mobile");
}
render();
</script>

<!-- Mobile Bottom Navigation (Premium Glow) -->
<nav class="mobileBottomNav" aria-label="Navigation">
  <button id="navHome" class="navBtn" type="button" aria-label="√úbersicht" title="√úbersicht">üè†</button>
  <button id="navStats" class="navBtn" type="button" aria-label="Statistik" title="Statistik">üìä</button>
  <button id="navAdd" class="navBtn navPlus" type="button" aria-label="Neu" title="Neu">Ôºã</button>
  <button id="navBackup" class="navBtn" type="button" aria-label="Backup" title="Backup">üíæ</button>
  <button id="navRestore" class="navBtn" type="button" aria-label="Restore" title="Restore">üìÇ</button>
  <button id="navLogout" class="navBtn" type="button" aria-label="Logout" title="Logout">üö™</button>
</nav>


<script>
(function(){
  const bind = (id, fn) => {
    const el = document.getElementById(id);
    if(el) el.addEventListener("click", fn);
  };
  bind("navHome", ()=> window.scrollTo({top:0, behavior:"smooth"}));
  bind("navStats", ()=> { const el = document.getElementById("statsCard"); if(el) el.scrollIntoView({behavior:"smooth", block:"start"}); });
  bind("navAdd", ()=> { if(typeof openAddModal === "function") openAddModal(); });
  bind("navBackup", ()=> { if(typeof downloadBackup === "function") downloadBackup(); });
  bind("navRestore", ()=> { if(typeof triggerRestore === "function") triggerRestore(); });
})();
</script>


<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(console.error);
    });
  }
</script>

</body>
</html>// Logout wiring (desktop/modal/bottom nav)
const __logout = () => { if (window.logout) window.logout(); };
const __b1 = document.getElementById("btnLogoutTop");
if (__b1) __b1.addEventListener("click", __logout);
const __b2 = document.getElementById("m_logout");
if (__b2) __b2.addEventListener("click", __logout);
const __b3 = document.getElementById("navLogout");
if (__b3) __b3.addEventListener("click", __logout);

